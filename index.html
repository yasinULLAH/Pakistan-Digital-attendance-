<!DOCTYPE html>
<html lang="ur" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>طلبہ کی حاضری اور نمبریں رجسٹر | Yasin Ullah</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            direction: rtl;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(45deg, #2c3e50, #3498db);
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .header h1 { font-size: 28px; margin-bottom: 10px; }
        
        .admin-section {
            background: #ecf0f1;
            padding: 15px;
            border-bottom: 2px solid #bdc3c7;
        }
        button, select, input{
            font-family: 'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif;
        }
        #marksTable th{
            background: black !important;
        }
        .admin-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .admin-item { display: flex; flex-direction: column; }
        
        .admin-item label {
            font-weight: bold;
            margin-bottom: 5px;
            color: #2c3e50;
        }
        
        .admin-item input, .admin-item select {
            padding: 8px;
            border: 1px solid #bdc3c7;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .controls {
            background: #f8f9fa;
            padding: 15px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            border-bottom: 1px solid #dee2e6;
        }
        
        .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            text-align: center;
        }
        
        .btn-primary { background: linear-gradient(45deg, #3498db, #2ecc71); color: white; }
        .btn-secondary { background: linear-gradient(45deg, #95a5a6, #7f8c8d); color: white; }
        .btn-danger { background: linear-gradient(45deg, #e74c3c, #c0392b); color: white; }
        .btn-warning { background: linear-gradient(45deg, #f39c12, #e67e22); color: white; }
        .btn-info { background: linear-gradient(45deg, #17a2b8, #138496); color: white; }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        
        .table-container {
            overflow-x: auto;
            max-height: 70vh;
            border: 1px solid #dee2e6;
        }
        
        .register-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
            background: white;
        }
        
        .register-table th, .register-table td {
            border: 1px solid #dee2e6;
            padding: 8px;
            text-align: center;
            position: relative;
        }
        
        .register-table th {
            background: linear-gradient(45deg, #34495e, #2c3e50);
            color: white;
            font-weight: bold;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .register-table tr:nth-child(even) { background-color: #f8f9fa; }
        .register-table tr:hover { background-color: #e3f2fd; }
        
        .student-name {
            min-width: 150px;
            text-align: right;
            font-weight: bold;
            background: #ecf0f1 !important;
            position: sticky;
            right: 0;
            z-index: 5;
        }
        
        .total-cell {
            background: #69cf0c !important;
            font-weight: bold;
            color: #ffffff !important;
        }
        
        .attendance-cell {
            width: 40px;
            height: 40px;
            cursor: pointer;
            user-select: none;
            font-size: 16px;
            font-weight: bold;
        }
        
        .present { background-color: #2ecc71; color: white; }
        .absent { background-color: #e74c3c; color: white; }
        .leave { background-color: #f39c12; color: white; }
        .holiday { background-color: #9b59b6; color: white; }
        
        .marks-cell { width: 60px; }
        .marks-cell input {
            width: 100%;
            border: none;
            text-align: center;
            font-size: 14px;
            padding: 5px;
        }
        
        .summary-row {
            background: #ecf0f1 !important;
            font-weight: bold;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }
        
        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 20px;
            width: 90%;
            max-width: 800px;
            border-radius: 10px;
            position: relative;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .close {
            position: absolute;
            top: 10px;
            left: 10px;
            font-size: 30px;
            cursor: pointer;
            color: #aaa;
        }
        
        .form-group { margin-bottom: 15px; }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
            flex-wrap: wrap;
        }
        
        .tab {
            padding: 15px 20px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 14px;
            font-weight: bold;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            flex: 1;
            min-width: 120px;
            box-shadow: 9px 0px 5px black;
            border-bottom-right-radius: 21px;
        }
        .tab:hover {
    padding: 15px 20px;
    cursor: pointer;
    border: none;
    background: none;
    font-size: 14px;
    font-weight: bold;
    border-bottom: 3px solid transparent;
    transition: all 0.3s ease;
    flex: 1;
    min-width: 120px;
    box-shadow: 9px 0px 5px rgb(155, 201, 172);
    border-bottom-right-radius: 21px;
    border-top-right-radius: 21px;
}
        
        .tab.active {
            background: #ffffff;
            border-bottom-color: #3498db;
            color: #3498db;
        }
        
        .tab-content { display: none; padding: 3px; }
        .tab-content.active { display: block; }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: linear-gradient(45deg, #3498db, #2ecc71);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        
        .stat-card h3 { font-size: 24px; margin-bottom: 5px; }
        
        .chart-container {
            background: white;
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .chart {
            width: 100%;
            height: 300px;
            position: relative;
        }
        
        .bar, .line-point {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 3px;
        }
        
        .filter-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .auto-save-indicator {
            position: fixed;
            top: 20px;
            left: 20px;
            background: #2ecc71;
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            display: none;
            z-index: 1001;
        }
        
        .logo-upload { text-align: center; margin-bottom: 20px; }
        .logo-preview {
            max-width: 150px;
            max-height: 100px;
            border-radius: 10px;
            margin-top: 10px;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px;
            border-radius: 5px;
            color: white;
            font-weight: bold;
            z-index: 1001;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }
        
        .notification.show { transform: translateX(0); }
        .notification.success { background: #2ecc71; }
        .notification.error { background: #e74c3c; }
        .notification.info { background: #3498db; }
        
        @media (max-width: 768px) {
            .container { margin: 0; border-radius: 0; }
            .admin-grid { grid-template-columns: 1fr; }
            .controls { grid-template-columns: repeat(2, 1fr); }
            .register-table { font-size: 11px; }
            .attendance-cell { width: 35px; height: 35px; font-size: 14px; }
            .tabs { flex-direction: column; }
            .tab { flex: none; }
        }
        
        @media (max-width: 480px) {
            .controls { grid-template-columns: 1fr; }
            .btn { padding: 12px; font-size: 13px; }
            .stats-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="auto-save-indicator" id="autoSaveIndicator">ڈیٹا محفوظ ہو رہا ہے...</div>
    <div class="notification" id="notification"></div>
    
    <div class="container">
        <div class="header">
            <div class="logo-upload">
                <input type="file" id="logoUpload" accept="image/*" style="display:none;">
                <button class="btn btn-secondary" onclick="document.getElementById('logoUpload').click()">لوگو اپ لوڈ کریں</button>
                <img id="logoPreview" class="logo-preview" style="display:none;">
            </div>
            <h1>طلبہ کی حاضری اور نمبریں رجسٹر</h1>
            <p>مصنف: یاسین اللہ - پاکستان</p>
        </div>

        <div class="admin-section">
            <div class="admin-grid">
                <div class="admin-item">
                    <label>اسکول کا نام</label>
                    <input type="text" id="schoolName" placeholder="اسکول کا نام">
                </div>
                <div class="admin-item">
                    <label>کلاس</label>
                    <input type="text" id="className" placeholder="کلاس">
                </div>
                <div class="admin-item">
                    <label>سیکشن</label>
                    <input type="text" id="sectionName" placeholder="سیکشن">
                </div>
                <div class="admin-item">
                    <label>استاد کا نام</label>
                    <input type="text" id="teacherName" placeholder="استاد کا نام">
                </div>
                <div class="admin-item">
                    <label>مہینہ/سال</label>
                    <input type="month" id="monthYear">
                </div>
                <div class="admin-item">
                    <label>رجسٹر منتخب کریں</label>
                    <select id="registerSelect"></select>
                </div>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab(event, 'attendance')">حاضری</button>
            <button class="tab" onclick="showTab(event, 'marks')">نمبریں</button>
            <button class="tab" onclick="showTab(event, 'reports')">رپورٹس</button>
            <button class="tab" onclick="showTab(event, 'analytics')">تجزیات</button>
            <button class="tab" onclick="showTab(event, 'bulk')">بلک آپریشن</button>
            <button class="tab" onclick="showTab(event, 'settings')">سیٹنگز</button>
        </div>

        <div id="attendance" class="tab-content active">
            <div class="controls">
                <button class="btn btn-primary" onclick="addStudent()">طالب علم شامل کریں</button>
                <button class="btn btn-secondary" onclick="generateDays()">دن بنائیں</button>
                <button class="btn btn-info" onclick="markAllPresent()">سب حاضر</button>
                <button class="btn btn-warning" onclick="markAllAbsent()">سب غیر حاضر</button>
                <button class="btn btn-secondary" onclick="markHoliday()">چھٹی کا دن</button>
                <button class="btn btn-info" onclick="copyPrevious()">پچھلا کاپی</button>
                <button class="btn btn-secondary" onclick="undo()">واپس</button>
                <button class="btn btn-secondary" onclick="redo()">دوبارہ</button>
                <select id="markingType">
                    <option value="symbols">نشان (✓/✗)</option>
                    <option value="letters">حروف (ح/غ/چ)</option>
                    <option value="arrows">تیر (↑/↓)</option>
                    <option value="numbers">نمبریں (1/0)</option>
                </select>
            </div>

            <div class="table-container">
                <table class="register-table" id="attendanceTable">
                    <thead>
                        <tr id="dateRow">
                            <th class="student-name">طالب علم کا نام</th>
                        </tr>
                    </thead>
                    <tbody id="attendanceBody"></tbody>
                    <tfoot>
                        <tr class="summary-row">
                            <td class="student-name">کل حاضری</td>
                        </tr>
                        <tr class="summary-row">
                            <td class="student-name">فیصد</td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>

        <div id="marks" class="tab-content">
            <div class="controls">
                <button class="btn btn-primary" onclick="addSubject()">مضمون شامل کریں</button>
                <button class="btn btn-info" onclick="addExam()">امتحان شامل کریں</button>
                <button class="btn btn-secondary" onclick="calculateGrades()">گریڈ شمار کریں</button>
                <button class="btn btn-warning" onclick="setPassMarks()">پاس نمبریں سیٹ کریں</button>
                <button class="btn btn-primary" onclick="saveMarks()">محفوظ کریں</button>
            </div>
            <div class="table-container">
                <table class="register-table" id="marksTable">
                    <thead>
                        <tr>
                            <th class="student-name">طالب علم</th>
                            <th>ریاضی</th>
                            <th>اردو</th>
                            <th>انگریزی</th>
                            <th>سائنس</th>
                            <th class="total-cell">کل</th>
                            <th class="total-cell">فیصد</th>
                            <th class="total-cell">گریڈ</th>
                            <th class="total-cell">نتیجہ</th>
                        </tr>
                    </thead>
                    <tbody id="marksBody"></tbody>
                    <tfoot>
                        <tr class="summary-row">
                            <td class="student-name">کل</td>
                        </tr>
                        <tr class="summary-row">
                            <td class="student-name">اوسط</td>
                        </tr>
                        <tr class="summary-row">
                            <td class="student-name">بہترین</td>
                        </tr>
                        <tr class="summary-row">
                            <td class="student-name">کم ترین</td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>

        <div id="reports" class="tab-content">
            <div class="filter-section">
                <h3>فلٹر</h3>
                <div class="filter-grid">
                    <div>
                        <label>رپورٹ کی قسم</label>
                        <select id="reportType">
                            <option value="attendance">حاضری</option>
                            <option value="marks">نمبریں</option>
                            <option value="summary">خلاصہ</option>
                            <option value="detailed">تفصیلی</option>
                            <option value="monthly">ماہانہ</option>
                            <option value="comparison">موازنہ</option>
                        </select>
                    </div>
                    <div>
                        <label>شروع کی تاریخ</label>
                        <input type="date" id="startDate">
                    </div>
                    <div>
                        <label>آخری تاریخ</label>
                        <input type="date" id="endDate">
                    </div>
                    <div>
                        <label>طالب علم</label>
                        <select id="studentFilter"></select>
                    </div>
                </div>
                <div class="controls">
                    <button class="btn btn-primary" onclick="generateReport()">رپورٹ بنائیں</button>
                    <button class="btn btn-secondary" onclick="exportPDF()">PDF</button>
                    <button class="btn btn-secondary" onclick="exportHTML()">HTML</button>
                    <button class="btn btn-secondary" onclick="exportExcel()">Excel</button>
                    <button class="btn btn-info" onclick="emailReport()">ای میل</button>
                    <button class="btn btn-secondary" onclick="printReport()">پرنٹ</button>
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <h3 id="totalStudents">0</h3>
                    <p>کل طلبہ</p>
                </div>
                <div class="stat-card">
                    <h3 id="avgAttendance">0%</h3>
                    <p>اوسط حاضری</p>
                </div>
                <div class="stat-card">
                    <h3 id="avgMarks">0</h3>
                    <p>اوسط نمبریں</p>
                </div>
                <div class="stat-card">
                    <h3 id="totalDays">0</h3>
                    <p>کل دن</p>
                </div>
                <div class="stat-card">
                    <h3 id="passRate">0%</h3>
                    <p>پاس کی شرح</p>
                </div>
                <div class="stat-card">
                    <h3 id="topStudent">-</h3>
                    <p>بہترین طالب علم</p>
                </div>
            </div>
            <div id="reportContent"></div>
        </div>

        <div id="analytics" class="tab-content">
            <div class="controls">
                <button class="btn btn-primary" onclick="generateCharts()">چارٹ بنائیں</button>
                <button class="btn btn-secondary" onclick="trendAnalysis()">رجحان کا تجزیہ</button>
                <button class="btn btn-info" onclick="performanceAnalysis()">کارکردگی</button>
                <select id="chartType">
                    <option value="bar">بار چارٹ</option>
                    <option value="line">لائن چارٹ</option>
                    <option value="pie">پائی چارٹ</option>
                    <option value="area">ایریا چارٹ</option>
                </select>
            </div>
            
            <div class="chart-container">
                <h3>حاضری کا چارٹ</h3>
                <div class="chart" id="attendanceChart"></div>
                <div class="legend" id="attendanceLegend"></div>
            </div>
            
            <div class="chart-container">
                <h3>نمبریں کا چارٹ</h3>
                <div class="chart" id="marksChart"></div>
                <div class="legend" id="marksLegend"></div>
            </div>

            <div class="chart-container">
                <h3>کارکردگی کا موازنہ</h3>
                <div class="chart" id="performanceChart"></div>
                <div class="legend" id="performanceLegend"></div>
            </div>
        </div>

        <div id="bulk" class="tab-content">
            <div class="controls">
                <button class="btn btn-primary" onclick="bulkAddStudents()">متعدد طلبہ شامل کریں</button>
                <button class="btn btn-info" onclick="bulkMarkAttendance()">بلک حاضری</button>
                <button class="btn btn-warning" onclick="bulkUpdateMarks()">بلک نمبریں</button>
                <button class="btn btn-secondary" onclick="promoteStudents()">کلاس ترقی</button>
                <button class="btn btn-danger" onclick="bulkDelete()">بلک ڈیلیٹ</button>
            </div>
            
            <div class="form-group">
                <label>CSV فائل امپورٹ کریں (نام، رول نمبر، والد کا نام)</label>
                <input type="file" id="csvImport" accept=".csv">
            </div>
            
            <div class="form-group">
                <label>متعدد طلبہ (ہر لائن میں ایک)</label>
                <textarea id="bulkStudentsText" rows="10" placeholder="احمد علی، 001، محمد علی&#10;فاطمہ خان، 002، احمد خان"></textarea>
            </div>
        </div>

        <div id="settings" class="tab-content">
            <div class="controls">
                <button class="btn btn-primary" onclick="createNewRegister()">نیا رجسٹر</button>
                <button class="btn btn-danger" onclick="deleteRegister()">رجسٹر ڈیلیٹ</button>
                <button class="btn btn-secondary" onclick="importData()">ڈیٹا امپورٹ</button>
                <button class="btn btn-secondary" onclick="exportData()">ڈیٹا ایکسپورٹ</button>
                <button class="btn btn-info" onclick="backupData()">بیک اپ</button>
                <button class="btn btn-warning" onclick="restoreData()">بحالی</button>
                <button class="btn btn-danger" onclick="resetAll()">ری سیٹ</button>
            </div>

            <div class="form-group">
                <label>خودکار محفوظ کرنا</label>
                <input type="checkbox" id="autoSave" checked>
            </div>

            <div class="form-group">
                <label>پاس مارکس</label>
                <input type="number" id="passMarks" value="40" min="0" max="100">
            </div>

            <div class="form-group">
                <label>کل مارکس</label>
                <input type="number" id="totalMarks" value="100" min="1" max="500">
            </div>

            <div class="form-group">
                <label>گریڈ سسٹم</label>
                <select id="gradeSystem">
                    <option value="letter">حروف (A, B, C, D, F)</option>
                    <option value="percentage">فیصد</option>
                    <option value="points">پوائنٹس</option>
                </select>
            </div>
        </div>
    </div>

    <div id="studentModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('studentModal')">&times;</span>
            <h2>طالب علم کی تفصیلات</h2>
            <div class="form-group">
                <label>نام</label>
                <input type="text" id="studentNameInput">
            </div>
            <div class="form-group">
                <label>رول نمبر</label>
                <input type="text" id="rollNumber">
            </div>
            <div class="form-group">
                <label>والد کا نام</label>
                <input type="text" id="fatherName">
            </div>
            <div class="form-group">
                <label>موبائل نمبر</label>
                <input type="tel" id="mobileNumber">
            </div>
            <div class="form-group">
                <label>پتہ</label>
                <textarea id="address" rows="3"></textarea>
            </div>
            <button class="btn btn-primary" onclick="saveStudent()">محفوظ کریں</button>
        </div>
    </div>

    <input type="file" id="dataImport" accept=".json" style="display:none">
    <input type="file" id="backupRestore" accept=".json" style="display:none">

    <script>
        let db1;
        let students2 = [];
        let attendance3 = {};
        let marks4 = {};
        let adminData5 = {};
        let currentRegister6 = 'default';
        let history7 = [];
        let historyIndex8 = -1;
        let markingTypes9 = {
            'symbols': {present: '✓', absent: '✗', leave: '○', holiday: '◆'},
            'letters': {present: 'ح', absent: 'غ', leave: 'چ', holiday: 'چھ'},
            'arrows': {present: '↑', absent: '↓', leave: '→', holiday: '◇'},
            'numbers': {present: '1', absent: '0', leave: '½', holiday: 'H'}
        };
        let autoSaveTimer;
        let subjects10 = ['ریاضی', 'اردو', 'انگریزی', 'سائنس'];
        let passMarks11 = 40;
        let totalMarks12 = 100;

        function initDB() {
            const request = indexedDB.open('StudentRegister', 2);
            
            request.onerror = function(event) {
                console.error('Database error:', event.target.error);
                showNotification('ڈیٹابیس ایرر', 'error');
            };
            
            request.onsuccess = function(event) {
                db1 = event.target.result;
                loadRegisters();
                loadData();
                showNotification('ڈیٹا لوڈ ہو گیا', 'success');
            };
            
            request.onupgradeneeded = function(event) {
                db1 = event.target.result;
                
                const stores = ['students', 'attendance', 'marks', 'admin', 'registers', 'subjects', 'exams'];
                
                stores.forEach(store => {
                    if (!db1.objectStoreNames.contains(store)) {
                        if (store === 'students') {
                            db1.createObjectStore(store, {keyPath: 'id', autoIncrement: true});
                        } else {
                            db1.createObjectStore(store, {keyPath: 'id'});
                        }
                    }
                });
            };
        }

        function autoSave() {
            if (document.getElementById('autoSave').checked) {
                clearTimeout(autoSaveTimer);
                autoSaveTimer = setTimeout(() => {
                    saveData(true);
                }, 2000);
            }
        }

        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type} show`;
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        function saveToHistory() {
            if (historyIndex8 < history7.length - 1) {
                history7 = history7.slice(0, historyIndex8 + 1);
            }
            
            history7.push({
                students: JSON.parse(JSON.stringify(students2)),
                attendance: JSON.parse(JSON.stringify(attendance3)),
                marks: JSON.parse(JSON.stringify(marks4))
            });
            
            if (history7.length > 50) {
                history7.shift();
            } else {
                historyIndex8++;
            }
        }

        function undo() {
            if (historyIndex8 > 0) {
                historyIndex8--;
                const state = history7[historyIndex8];
                students2 = JSON.parse(JSON.stringify(state.students));
                attendance3 = JSON.parse(JSON.stringify(state.attendance));
                marks4 = JSON.parse(JSON.stringify(state.marks));
                renderAttendanceTable();
                renderMarksTable();
                showNotification('واپس کیا گیا', 'info');
            }
        }

        function redo() {
            if (historyIndex8 < history7.length - 1) {
                historyIndex8++;
                const state = history7[historyIndex8];
                students2 = JSON.parse(JSON.stringify(state.students));
                attendance3 = JSON.parse(JSON.stringify(state.attendance));
                marks4 = JSON.parse(JSON.stringify(state.marks));
                renderAttendanceTable();
                renderMarksTable();
                showNotification('دوبارہ کیا گیا', 'info');
            }
        }

   function loadData() {
    const transaction = db1.transaction(['students', 'attendance', 'marks', 'admin', 'subjects'], 'readonly');
    
    transaction.objectStore('students').getAll().onsuccess = function(event) {
        const allStudents = event.target.result.filter(s => s.register === currentRegister6);
        students2 = allStudents;
        renderAttendanceTable();
        renderMarksTable();
        updateStudentFilter();
    };
    
    transaction.objectStore('attendance').get(currentRegister6).onsuccess = function(event) {
        attendance3 = event.target.result ? event.target.result.data : {};
        renderAttendanceTable();
    };
    
    transaction.objectStore('marks').get(currentRegister6).onsuccess = function(event) {
        marks4 = event.target.result ? event.target.result.data : {};
        renderMarksTable();
    };
    
    transaction.objectStore('admin').get(currentRegister6).onsuccess = function(event) {
        if (event.target.result) {
            adminData5 = event.target.result.data;
            loadAdminData();
        }
    };

    // Fix for loading subjects
    transaction.objectStore('subjects').get(currentRegister6).onsuccess = function(event) {
        if (event.target.result && event.target.result.data) {
            subjects10 = event.target.result.data;
            renderMarksTable(); // Re-render marks table with loaded subjects
        }
    };
}


        function saveData(isAuto = false) {
    if (isAuto) {
        document.getElementById('autoSaveIndicator').style.display = 'block';
    } else {
        saveToHistory();
    }
    
    const transaction = db1.transaction(['students', 'attendance', 'marks', 'admin', 'subjects'], 'readwrite');
    
    // Clear existing students for this register first to avoid duplicates
    const studentStore = transaction.objectStore('students');
    studentStore.getAll().onsuccess = function(event) {
        const allStudents = event.target.result;
        const toDelete = allStudents.filter(s => s.register === currentRegister6);
        
        toDelete.forEach(student => {
            studentStore.delete(student.id);
        });
        
        // Add current students
        students2.forEach(student => {
            student.register = currentRegister6;
            studentStore.add(student);
        });
    };
    
    transaction.objectStore('attendance').put({id: currentRegister6, data: attendance3});
    transaction.objectStore('marks').put({id: currentRegister6, data: marks4});
    transaction.objectStore('subjects').put({id: currentRegister6, data: subjects10});
    
    saveAdminData();
    
    transaction.oncomplete = function() {
        if (isAuto) {
            setTimeout(() => {
                document.getElementById('autoSaveIndicator').style.display = 'none';
            }, 1000);
        } else {
            showNotification('ڈیٹا محفوظ ہو گیا', 'success');
        }
    };
}


        function loadAdminData() {
            document.getElementById('schoolName').value = adminData5.schoolName || '';
            document.getElementById('className').value = adminData5.className || '';
            document.getElementById('sectionName').value = adminData5.sectionName || '';
            document.getElementById('teacherName').value = adminData5.teacherName || '';
            document.getElementById('monthYear').value = adminData5.monthYear || '';
            document.getElementById('passMarks').value = adminData5.passMarks || 40;
            document.getElementById('totalMarks').value = adminData5.totalMarks || 100;
            
            passMarks11 = parseInt(adminData5.passMarks) || 40;
            totalMarks12 = parseInt(adminData5.totalMarks) || 100;
        }

        function saveAdminData() {
            adminData5 = {
                schoolName: document.getElementById('schoolName').value,
                className: document.getElementById('className').value,
                sectionName: document.getElementById('sectionName').value,
                teacherName: document.getElementById('teacherName').value,
                monthYear: document.getElementById('monthYear').value,
                passMarks: document.getElementById('passMarks').value,
                totalMarks: document.getElementById('totalMarks').value
            };
            
            const transaction = db1.transaction(['admin'], 'readwrite');
            transaction.objectStore('admin').put({id: currentRegister6, data: adminData5});
        }

        function updateStudentFilter() {
            const select = document.getElementById('studentFilter');
            select.innerHTML = '<option value="">تمام طلبہ</option>';
            
            students2.forEach((student, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = student.name;
                select.appendChild(option);
            });
        }

        function addStudent() {
            document.getElementById('studentModal').style.display = 'block';
            clearStudentForm();
        }

        function clearStudentForm() {
            document.getElementById('studentNameInput').value = '';
            document.getElementById('rollNumber').value = '';
            document.getElementById('fatherName').value = '';
            document.getElementById('mobileNumber').value = '';
            document.getElementById('address').value = '';
        }

        function saveStudent() {
    const name = document.getElementById('studentNameInput').value.trim();
    const roll = document.getElementById('rollNumber').value.trim();
    const father = document.getElementById('fatherName').value.trim();
    const mobile = document.getElementById('mobileNumber').value.trim();
    const address = document.getElementById('address').value.trim();
    
    if (name) {
        // Check for duplicates before adding
        const existingStudent = students2.find(s => s.name === name && s.rollNumber === roll);
        if (existingStudent) {
            showNotification('یہ طالب علم پہلے سے موجود ہے', 'error');
            return;
        }
        
        const student = {
            name: name,
            rollNumber: roll,
            fatherName: father,
            mobileNumber: mobile,
            address: address,
            register: currentRegister6
        };
        
        students2.push(student);
        renderAttendanceTable();
        renderMarksTable();
        updateStudentFilter();
        closeModal('studentModal');
        autoSave();
        showNotification('طالب علم شامل کر دیا گیا', 'success');
    }
}


        function generateDays() {
            const monthYear = document.getElementById('monthYear').value;
            if (!monthYear) {
                showNotification('پہلے مہینہ منتخب کریں', 'error');
                return;
            }
            
            const year = parseInt(monthYear.split('-')[0]);
            const month = parseInt(monthYear.split('-')[1]) - 1;
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            const dateRow = document.getElementById('dateRow');
            dateRow.innerHTML = '<th class="student-name">طالب علم کا نام</th>';
            
            for (let day = 1; day <= Math.min(daysInMonth, 31); day++) {
                const th = document.createElement('th');
                th.textContent = day;
                th.className = 'attendance-cell';
                th.addEventListener('click', () => markColumnAttendance(day));
                dateRow.appendChild(th);
            }
            
            const totalTh = document.createElement('th');
            totalTh.textContent = 'کل';
            totalTh.className = 'total-cell';
            dateRow.appendChild(totalTh);
            
            const percentTh = document.createElement('th');
            percentTh.textContent = '%';
            percentTh.className = 'total-cell';
            dateRow.appendChild(percentTh);
            
            renderAttendanceTable();
            showNotification('دن بنا دیے گئے', 'success');
        }

        function markColumnAttendance(day) {
            const status = prompt('دن کی حاضری:\n1 = حاضر\n2 = غیر حاضر\n3 = چھٹی\n4 = تعطیل');
            if (!status) return;
            
            let newStatus;
            switch(status) {
                case '1': newStatus = 'present'; break;
                case '2': newStatus = 'absent'; break;
                case '3': newStatus = 'leave'; break;
                case '4': newStatus = 'holiday'; break;
                default: return;
            }
            
            students2.forEach((_, studentIndex) => {
                const attendanceKey = `${studentIndex}_${day}`;
                attendance3[attendanceKey] = newStatus;
            });
            
            renderAttendanceTable();
            autoSave();
        }

        function renderAttendanceTable() {
            const tbody = document.getElementById('attendanceBody');
            tbody.innerHTML = '';
            
            students2.forEach((student, studentIndex) => {
                const row = document.createElement('tr');
                
                const nameCell = document.createElement('td');
                nameCell.className = 'student-name';
                nameCell.innerHTML = `${student.name} <button class="btn btn-danger" style="font-size:10px;padding:2px 5px;" onclick="removeStudent(${studentIndex})">×</button>`;
                nameCell.contentEditable = true;
                nameCell.addEventListener('blur', () => {
                    students2[studentIndex].name = nameCell.textContent.replace('×', '').trim();
                    autoSave();
                });
                row.appendChild(nameCell);
                
                const dateRow = document.getElementById('dateRow');
                const dayCount = dateRow.children.length - 3;
                let presentCount = 0;
                
                for (let day = 1; day <= dayCount; day++) {
                    const cell = document.createElement('td');
                    cell.className = 'attendance-cell';
                    
                    const attendanceKey = `${studentIndex}_${day}`;
                    const status = attendance3[attendanceKey] || 'absent';
                    
                    if (status === 'present') presentCount++;
                    
                    updateAttendanceCell(cell, status);
                    
                    cell.addEventListener('click', () => {
                        const currentStatus = attendance3[attendanceKey] || 'absent';
                        let newStatus;
                        
                        if (currentStatus === 'absent') newStatus = 'present';
                        else if (currentStatus === 'present') newStatus = 'leave';
                        else if (currentStatus === 'leave') newStatus = 'holiday';
                        else newStatus = 'absent';
                        
                        attendance3[attendanceKey] = newStatus;
                        updateAttendanceCell(cell, newStatus);
                        updateRowTotals(row, studentIndex, dayCount);
                        updateColumnTotals();
                        autoSave();
                    });
                    
                    row.appendChild(cell);
                }
                
                const totalCell = document.createElement('td');
                totalCell.className = 'total-cell';
                totalCell.textContent = presentCount;
                row.appendChild(totalCell);
                
                const percentCell = document.createElement('td');
                percentCell.className = 'total-cell';
                const percentage = dayCount > 0 ? Math.round((presentCount / dayCount) * 100) : 0;
                percentCell.textContent = `${percentage}%`;
                row.appendChild(percentCell);
                
                tbody.appendChild(row);
            });
            
            updateColumnTotals();
        }

        function updateRowTotals(row, studentIndex, dayCount) {
            let presentCount = 0;
            
            for (let day = 1; day <= dayCount; day++) {
                const attendanceKey = `${studentIndex}_${day}`;
                if (attendance3[attendanceKey] === 'present') {
                    presentCount++;
                }
            }
            
            const cells = row.querySelectorAll('.total-cell');
            if (cells.length >= 2) {
                cells[0].textContent = presentCount;
                const percentage = dayCount > 0 ? Math.round((presentCount / dayCount) * 100) : 0;
                cells[1].textContent = `${percentage}%`;
            }
        }

        function updateColumnTotals() {
            const dateRow = document.getElementById('dateRow');
            const dayCount = dateRow.children.length - 3;
            
            const summaryRows = document.querySelectorAll('.summary-row');
            
            summaryRows[0].innerHTML = '<td class="student-name">کل حاضری</td>';
            summaryRows[1].innerHTML = '<td class="student-name">فیصد</td>';
            
            let totalPresent = 0;
            let totalPossible = 0;
            
            for (let day = 1; day <= dayCount; day++) {
                let presentCount = 0;
                
                students2.forEach((_, studentIndex) => {
                    const attendanceKey = `${studentIndex}_${day}`;
                    if (attendance3[attendanceKey] === 'present') {
                        presentCount++;
                    }
                });
                
                totalPresent += presentCount;
                totalPossible += students2.length;
                
                const totalCell = document.createElement('td');
                totalCell.textContent = presentCount;
                summaryRows[0].appendChild(totalCell);
                
                const percentCell = document.createElement('td');
                const percentage = students2.length > 0 ? Math.round((presentCount / students2.length) * 100) : 0;
                percentCell.textContent = `${percentage}%`;
                summaryRows[1].appendChild(percentCell);
            }
            
            const grandTotalCell = document.createElement('td');
            grandTotalCell.className = 'total-cell';
            grandTotalCell.textContent = totalPresent;
            summaryRows[0].appendChild(grandTotalCell);
            
            const grandPercentCell = document.createElement('td');
            grandPercentCell.className = 'total-cell';
            const grandPercent = totalPossible > 0 ? Math.round((totalPresent / totalPossible) * 100) : 0;
            grandPercentCell.textContent = `${grandPercent}%`;
            summaryRows[1].appendChild(grandPercentCell);
            
            const emptyCell1 = document.createElement('td');
            const emptyCell2 = document.createElement('td');
            summaryRows[0].appendChild(emptyCell1);
            summaryRows[1].appendChild(emptyCell2);
        }

        function updateAttendanceCell(cell, status) {
            const markingType = document.getElementById('markingType').value;
            const symbols = markingTypes9[markingType];
            
            cell.className = `attendance-cell ${status}`;
            cell.textContent = symbols[status];
        }

        function removeStudent(index) {
            if (confirm('کیا آپ اس طالب علم کو ہٹانا چاہتے ہیں؟')) {
                students2.splice(index, 1);
                renderAttendanceTable();
                renderMarksTable();
                updateStudentFilter();
                autoSave();
                showNotification('طالب علم ہٹا دیا گیا', 'info');
            }
        }

        function renderMarksTable() {
            const tbody = document.getElementById('marksBody');
            const thead = document.querySelector('#marksTable thead tr');
            
            thead.innerHTML = `
                <th class="student-name">طالب علم</th>
                ${subjects10.map(subject => `<th>${subject}</th>`).join('')}
                <th class="total-cell">کل</th>
                <th class="total-cell">فیصد</th>
                <th class="total-cell">گریڈ</th>
                <th class="total-cell">نتیجہ</th>
            `;
            
            tbody.innerHTML = '';
            
            students2.forEach((student, studentIndex) => {
                const row = document.createElement('tr');
                
                const nameCell = document.createElement('td');
                nameCell.className = 'student-name';
                nameCell.textContent = student.name;
                row.appendChild(nameCell);
                
                let total = 0;
                
                subjects10.forEach(subject => {
                    const cell = document.createElement('td');
                    cell.className = 'marks-cell';
                    
                    const input = document.createElement('input');
                    input.type = 'number';
                    input.min = '0';
                    input.max = totalMarks12.toString();
                    const markKey = `${studentIndex}_${subject}`;
                    input.value = marks4[markKey] || '';
                    
                    input.addEventListener('input', () => {
                        marks4[markKey] = parseInt(input.value) || 0;
                        calculateRowMarks(row, studentIndex);
                        calculateSubjectTotals();
                        autoSave();
                    });
                    
                    cell.appendChild(input);
                    row.appendChild(cell);
                    
                    total += parseInt(input.value) || 0;
                });
                
                const totalCell = document.createElement('td');
                totalCell.className = 'total-cell';
                totalCell.textContent = total;
                row.appendChild(totalCell);
                
                const maxMarks = subjects10.length * totalMarks12;
                const percentage = Math.round((total / maxMarks) * 100);
                
                const percentCell = document.createElement('td');
                percentCell.className = 'total-cell';
                percentCell.textContent = `${percentage}%`;
                row.appendChild(percentCell);
                
                const gradeCell = document.createElement('td');
                gradeCell.className = 'total-cell';
                gradeCell.textContent = calculateGrade(percentage);
                row.appendChild(gradeCell);
                
                const resultCell = document.createElement('td');
                resultCell.className = 'total-cell';
                resultCell.textContent = percentage >= passMarks11 ? 'کامیاب' : 'ناکام';
                resultCell.style.color = percentage >= passMarks11 ? 'green' : 'red';
                row.appendChild(resultCell);
                
                tbody.appendChild(row);
            });
            
            calculateSubjectTotals();
        }

        function calculateRowMarks(row, studentIndex) {
            const inputs = row.querySelectorAll('input[type="number"]');
            let total = 0;
            
            inputs.forEach(input => {
                total += parseInt(input.value) || 0;
            });
            
            const maxMarks = subjects10.length * totalMarks12;
            const percentage = Math.round((total / maxMarks) * 100);
            
            const cells = row.querySelectorAll('.total-cell');
            if (cells.length >= 4) {
                cells[0].textContent = total;
                cells[1].textContent = `${percentage}%`;
                cells[2].textContent = calculateGrade(percentage);
                cells[3].textContent = percentage >= passMarks11 ? 'کامیاب' : 'ناکام';
                cells[3].style.color = percentage >= passMarks11 ? 'green' : 'red';
            }
        }

        function calculateSubjectTotals() {
            const tfoot = document.querySelector('#marksTable tfoot');
            tfoot.innerHTML = '';
            
            const summaryTypes = [
                {label: 'کل', calc: 'sum'},
                {label: 'اوسط', calc: 'avg'},
                {label: 'بہترین', calc: 'max'},
                {label: 'کم ترین', calc: 'min'}
            ];
            
            summaryTypes.forEach(summaryType => {
                const row = document.createElement('tr');
                row.className = 'summary-row';
                
                const labelCell = document.createElement('td');
                labelCell.className = 'student-name';
                labelCell.textContent = summaryType.label;
                row.appendChild(labelCell);
                
                subjects10.forEach(subject => {
                    const cell = document.createElement('td');
                    const values = [];
                    
                    students2.forEach((_, studentIndex) => {
                        const markKey = `${studentIndex}_${subject}`;
                        const value = marks4[markKey] || 0;
                        values.push(value);
                    });
                    
                    let result = 0;
                    switch(summaryType.calc) {
                        case 'sum':
                            result = values.reduce((a, b) => a + b, 0);
                            break;
                        case 'avg':
                            result = values.length > 0 ? Math.round(values.reduce((a, b) => a + b, 0) / values.length) : 0;
                            break;
                        case 'max':
                            result = values.length > 0 ? Math.max(...values) : 0;
                            break;
                        case 'min':
                            result = values.length > 0 ? Math.min(...values) : 0;
                            break;
                    }
                    
                    cell.textContent = result;
                    row.appendChild(cell);
                });
                
                for (let i = 0; i < 4; i++) {
                    const emptyCell = document.createElement('td');
                    row.appendChild(emptyCell);
                }
                
                tfoot.appendChild(row);
            });
        }

        function calculateGrade(percentage) {
            const gradeSystem = document.getElementById('gradeSystem').value;
            
            switch(gradeSystem) {
                case 'letter':
                    if (percentage >= 90) return 'A+';
                    if (percentage >= 80) return 'A';
                    if (percentage >= 70) return 'B';
                    if (percentage >= 60) return 'C';
                    if (percentage >= 50) return 'D';
                    return 'F';
                case 'percentage':
                    return `${percentage}%`;
                case 'points':
                    return `${(percentage / 25).toFixed(1)}`;
                default:
                    return 'N/A';
            }
        }

        function markAllPresent() {
            const dateRow = document.getElementById('dateRow');
            const dayCount = dateRow.children.length - 3;
            
            students2.forEach((_, studentIndex) => {
                for (let day = 1; day <= dayCount; day++) {
                    const attendanceKey = `${studentIndex}_${day}`;
                    attendance3[attendanceKey] = 'present';
                }
            });
            
            renderAttendanceTable();
            autoSave();
            showNotification('تمام طلبہ حاضر مارک کیے گئے', 'success');
        }

        function markAllAbsent() {
            const dateRow = document.getElementById('dateRow');
            const dayCount = dateRow.children.length - 3;
            
            students2.forEach((_, studentIndex) => {
                for (let day = 1; day <= dayCount; day++) {
                    const attendanceKey = `${studentIndex}_${day}`;
                    attendance3[attendanceKey] = 'absent';
                }
            });
            
            renderAttendanceTable();
            autoSave();
            showNotification('تمام طلبہ غیر حاضر مارک کیے گئے', 'info');
        }

        function markHoliday() {
            const day = prompt('کون سا دن چھٹی کا ہے؟');
            if (day && !isNaN(day)) {
                students2.forEach((_, studentIndex) => {
                    const attendanceKey = `${studentIndex}_${day}`;
                    attendance3[attendanceKey] = 'holiday';
                });
                
                renderAttendanceTable();
                autoSave();
                showNotification(`دن ${day} چھٹی مارک کیا گیا`, 'info');
            }
        }

        function copyPrevious() {
            const day = prompt('کون سے دن سے کاپی کریں؟');
            const targetDay = prompt('کون سے دن میں کاپی کریں؟');
            
            if (day && targetDay && !isNaN(day) && !isNaN(targetDay)) {
                students2.forEach((_, studentIndex) => {
                    const sourceKey = `${studentIndex}_${day}`;
                    const targetKey = `${studentIndex}_${targetDay}`;
                    if (attendance3[sourceKey]) {
                        attendance3[targetKey] = attendance3[sourceKey];
                    }
                });
                
                renderAttendanceTable();
                autoSave();
                showNotification(`دن ${day} سے ${targetDay} میں کاپی کیا گیا`, 'success');
            }
        }

        function showTab(evt, tabName) {
            const tabs = document.querySelectorAll('.tab-content');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            const tabButtons = document.querySelectorAll('.tab');
            tabButtons.forEach(button => button.classList.remove('active'));
            
            document.getElementById(tabName).classList.add('active');
            evt.currentTarget.classList.add('active');
            
            if (tabName === 'reports') {
                generateStats();
            } else if (tabName === 'analytics') {
                generateCharts();
            }
        }

        function generateStats() {
            document.getElementById('totalStudents').textContent = students2.length;
            
            const totalDays = document.getElementById('dateRow').children.length - 3;
            document.getElementById('totalDays').textContent = totalDays;
            
            let totalPresent = 0;
            let totalPossible = students2.length * totalDays;
            
            Object.values(attendance3).forEach(status => {
                if (status === 'present') totalPresent++;
            });
            
            const avgAttendance = totalPossible > 0 ? Math.round((totalPresent / totalPossible) * 100) : 0;
            document.getElementById('avgAttendance').textContent = `${avgAttendance}%`;
            
            let totalMarksSum = 0;
            let marksCount = 0;
            
            Object.values(marks4).forEach(mark => {
                if (typeof mark === 'number') {
                    totalMarksSum += mark;
                    marksCount++;
                }
            });
            
            const avgMarks = marksCount > 0 ? Math.round(totalMarksSum / marksCount) : 0;
            document.getElementById('avgMarks').textContent = avgMarks;
            
            let passCount = 0;
            students2.forEach((_, studentIndex) => {
                let studentTotal = 0;
                subjects10.forEach(subject => {
                    const markKey = `${studentIndex}_${subject}`;
                    studentTotal += marks4[markKey] || 0;
                });
                const percentage = (studentTotal / (subjects10.length * totalMarks12)) * 100;
                if (percentage >= passMarks11) passCount++;
            });
            
            const passRate = students2.length > 0 ? Math.round((passCount / students2.length) * 100) : 0;
            document.getElementById('passRate').textContent = `${passRate}%`;
            
            let topStudent = '-';
            let topMarks = -1;
            students2.forEach((student, studentIndex) => {
                let studentTotal = 0;
                subjects10.forEach(subject => {
                    const markKey = `${studentIndex}_${subject}`;
                    studentTotal += marks4[markKey] || 0;
                });
                if (studentTotal > topMarks) {
                    topMarks = studentTotal;
                    topStudent = student.name;
                }
            });
            
            document.getElementById('topStudent').textContent = topStudent;
        }

        function generateCharts() {
            generateAttendanceChart();
            generateMarksChart();
            generatePerformanceChart();
        }
        function generateAttendanceChart() {
            const chartContainer = document.getElementById('attendanceChart');
            chartContainer.innerHTML = '';
            
            const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            svg.setAttribute('width', '100%');
            svg.setAttribute('height', '300');
            svg.setAttribute('viewBox', '0 0 800 300');
            
            const chartType = document.getElementById('chartType').value;
            const dateRow = document.getElementById('dateRow');
            const dayCount = dateRow.children.length - 3;
            
            if (chartType === 'bar') {
                const barWidth = 800 / dayCount;
                
                for (let day = 1; day <= dayCount; day++) {
                    let presentCount = 0;
                    students2.forEach((_, studentIndex) => {
                        const attendanceKey = `${studentIndex}_${day}`;
                        if (attendance3[attendanceKey] === 'present') {
                            presentCount++;
                        }
                    });
                    
                    const barHeight = (presentCount / students2.length) * 250;
                    const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                    rect.setAttribute('x', (day - 1) * barWidth);
                    rect.setAttribute('y', 250 - barHeight);
                    rect.setAttribute('width', barWidth - 2);
                    rect.setAttribute('height', barHeight);
                    rect.setAttribute('fill', '#3498db');
                    rect.className = 'bar';
                    
                    rect.addEventListener('mouseover', function() {
                        this.setAttribute('fill', '#2980b9');
                    });
                    
                    rect.addEventListener('mouseout', function() {
                        this.setAttribute('fill', '#3498db');
                    });
                    
                    svg.appendChild(rect);
                    
                    const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                    text.setAttribute('x', (day - 1) * barWidth + barWidth / 2);
                    text.setAttribute('y', 270);
                    text.setAttribute('text-anchor', 'middle');
                    text.setAttribute('font-size', '12');
                    text.textContent = day;
                    svg.appendChild(text);
                }
            }
            
            chartContainer.appendChild(svg);
            
            const legend = document.getElementById('attendanceLegend');
            legend.innerHTML = `
                <div class="legend-item">
                    <div class="legend-color" style="background: #3498db;"></div>
                    <span>حاضری کی شرح</span>
                </div>
            `;
        }

        function generateMarksChart() {
            const chartContainer = document.getElementById('marksChart');
            chartContainer.innerHTML = '';
            
            const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            svg.setAttribute('width', '100%');
            svg.setAttribute('height', '300');
            svg.setAttribute('viewBox', '0 0 800 300');
            
            const colors = ['#e74c3c', '#2ecc71', '#f39c12', '#9b59b6', '#3498db'];
            const barWidth = 800 / students2.length;
            
            students2.forEach((student, studentIndex) => {
                let total = 0;
                subjects10.forEach(subject => {
                    const markKey = `${studentIndex}_${subject}`;
                    total += marks4[markKey] || 0;
                });
                
                const maxMarks = subjects10.length * totalMarks12;
                const percentage = (total / maxMarks) * 100;
                const barHeight = (percentage / 100) * 250;
                
                const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                rect.setAttribute('x', studentIndex * barWidth);
                rect.setAttribute('y', 250 - barHeight);
                rect.setAttribute('width', barWidth - 2);
                rect.setAttribute('height', barHeight);
                rect.setAttribute('fill', colors[studentIndex % colors.length]);
                rect.className = 'bar';
                
                rect.addEventListener('mouseover', function() {
                    const tooltip = document.createElement('div');
                    tooltip.style.position = 'absolute';
                    tooltip.style.background = '#2c3e50';
                    tooltip.style.color = 'white';
                    tooltip.style.padding = '5px';
                    tooltip.style.borderRadius = '3px';
                    tooltip.style.fontSize = '12px';
                    tooltip.textContent = `${student.name}: ${percentage.toFixed(1)}%`;
                    document.body.appendChild(tooltip);
                    
                    setTimeout(() => {
                        if (tooltip.parentNode) {
                            tooltip.parentNode.removeChild(tooltip);
                        }
                    }, 2000);
                });
                
                svg.appendChild(rect);
            });
            
            chartContainer.appendChild(svg);
        }

        function generatePerformanceChart() {
            const chartContainer = document.getElementById('performanceChart');
            chartContainer.innerHTML = '';
            
            const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            svg.setAttribute('width', '100%');
            svg.setAttribute('height', '300');
            svg.setAttribute('viewBox', '0 0 400 400');
            
            let passCount = 0;
            let failCount = 0;
            
            students2.forEach((_, studentIndex) => {
                let studentTotal = 0;
                subjects10.forEach(subject => {
                    const markKey = `${studentIndex}_${subject}`;
                    studentTotal += marks4[markKey] || 0;
                });
                const percentage = (studentTotal / (subjects10.length * totalMarks12)) * 100;
                if (percentage >= passMarks11) {
                    passCount++;
                } else {
                    failCount++;
                }
            });
            
            const total = passCount + failCount;
            if (total === 0) return;
            
            const passAngle = (passCount / total) * 2 * Math.PI;
            const failAngle = (failCount / total) * 2 * Math.PI;
            
            const centerX = 200;
            const centerY = 200;
            const radius = 150;
            
            const passSector = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            const passEndX = centerX + radius * Math.cos(passAngle);
            const passEndY = centerY + radius * Math.sin(passAngle);
            const largeArcFlag = passAngle > Math.PI ? 1 : 0;
            
            passSector.setAttribute('d', `M ${centerX} ${centerY} L ${centerX + radius} ${centerY} A ${radius} ${radius} 0 ${largeArcFlag} 1 ${passEndX} ${passEndY} Z`);
            passSector.setAttribute('fill', '#2ecc71');
            svg.appendChild(passSector);
            
            if (failCount > 0) {
                const failSector = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                const failEndX = centerX + radius * Math.cos(passAngle + failAngle);
                const failEndY = centerY + radius * Math.sin(passAngle + failAngle);
                const failLargeArcFlag = failAngle > Math.PI ? 1 : 0;
                
                failSector.setAttribute('d', `M ${centerX} ${centerY} L ${passEndX} ${passEndY} A ${radius} ${radius} 0 ${failLargeArcFlag} 1 ${failEndX} ${failEndY} Z`);
                failSector.setAttribute('fill', '#e74c3c');
                svg.appendChild(failSector);
            }
            
            chartContainer.appendChild(svg);
            
            const legend = document.getElementById('performanceLegend');
            legend.innerHTML = `
                <div class="legend-item">
                    <div class="legend-color" style="background: #2ecc71;"></div>
                    <span>کامیاب (${passCount})</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #e74c3c;"></div>
                    <span>ناکام (${failCount})</span>
                </div>
            `;
        }

       function addSubject() {
    const subjectName = prompt('نیا مضمون کا نام:');
    if (subjectName && subjectName.trim()) {
        // Check if subject already exists
        if (subjects10.includes(subjectName.trim())) {
            showNotification('یہ مضمون پہلے سے موجود ہے', 'error');
            return;
        }
        
        subjects10.push(subjectName.trim());
        renderMarksTable();
        
        // Immediately save subjects to DB
        const transaction = db1.transaction(['subjects'], 'readwrite');
        transaction.objectStore('subjects').put({id: currentRegister6, data: subjects10});
        
        autoSave();
        showNotification('نیا مضمون شامل کر دیا گیا', 'success');
    }
}


        function addExam() {
            const examName = prompt('امتحان کا نام:');
            const examDate = prompt('امتحان کی تاریخ (YYYY-MM-DD):');
            
            if (examName && examDate) {
                const exam = {
                    name: examName,
                    date: examDate,
                    subjects: [...subjects10]
                };
                
                const transaction = db1.transaction(['exams'], 'readwrite');
                transaction.objectStore('exams').put({id: `${currentRegister6}_${Date.now()}`, data: exam});
                
                showNotification('امتحان شامل کر دیا گیا', 'success');
            }
        }

        function calculateGrades() {
            renderMarksTable();
            showNotification('گریڈز شمار کر دیے گئے', 'success');
        }

        function setPassMarks() {
            const newPassMarks = prompt('پاس مارکس:', passMarks11);
            if (newPassMarks && !isNaN(newPassMarks)) {
                passMarks11 = parseInt(newPassMarks);
                document.getElementById('passMarks').value = passMarks11;
                renderMarksTable();
                autoSave();
                showNotification('پاس مارکس اپڈیٹ کر دیے گئے', 'success');
            }
        }

        function bulkAddStudents() {
            const text = document.getElementById('bulkStudentsText').value;
            if (!text.trim()) {
                showNotification('طلبہ کی فہرست خالی ہے', 'error');
                return;
            }
            
            const lines = text.split('\n');
            let addedCount = 0;
            
            lines.forEach(line => {
                const parts = line.split(',').map(p => p.trim());
                if (parts.length >= 1 && parts[0]) {
                    const student = {
                        name: parts[0],
                        rollNumber: parts[1] || '',
                        fatherName: parts[2] || '',
                        mobileNumber: parts[3] || '',
                        address: parts[4] || '',
                        register: currentRegister6
                    };
                    students2.push(student);
                    addedCount++;
                }
            });
            
            if (addedCount > 0) {
                renderAttendanceTable();
                renderMarksTable();
                updateStudentFilter();
                autoSave();
                showNotification(`${addedCount} طلبہ شامل کر دیے گئے`, 'success');
                document.getElementById('bulkStudentsText').value = '';
            }
        }

        function bulkMarkAttendance() {
            const date = prompt('تاریخ (دن کا نمبر):');
            const status = prompt('حاضری کی قسم:\n1 = حاضر\n2 = غیر حاضر\n3 = چھٹی\n4 = تعطیل');
            
            if (date && status) {
                let newStatus;
                switch(status) {
                    case '1': newStatus = 'present'; break;
                    case '2': newStatus = 'absent'; break;
                    case '3': newStatus = 'leave'; break;
                    case '4': newStatus = 'holiday'; break;
                    default: return;
                }
                
                students2.forEach((_, studentIndex) => {
                    const attendanceKey = `${studentIndex}_${date}`;
                    attendance3[attendanceKey] = newStatus;
                });
                
                renderAttendanceTable();
                autoSave();
                showNotification('بلک حاضری مارک کر دی گئی', 'success');
            }
        }

        function bulkUpdateMarks() {
            const subject = prompt('مضمون منتخب کریں:\n' + subjects10.map((s, i) => `${i + 1}. ${s}`).join('\n'));
            const marks = prompt('نمبریں (کاما سے الگ کریں):');
            
            if (subject && marks) {
                const subjectIndex = parseInt(subject) - 1;
                if (subjectIndex >= 0 && subjectIndex < subjects10.length) {
                    const marksArray = marks.split(',').map(m => parseInt(m.trim()) || 0);
                    const subjectName = subjects10[subjectIndex];
                    
                    students2.forEach((_, studentIndex) => {
                        if (studentIndex < marksArray.length) {
                            const markKey = `${studentIndex}_${subjectName}`;
                            marks4[markKey] = marksArray[studentIndex];
                        }
                    });
                    
                    renderMarksTable();
                    autoSave();
                    showNotification('بلک نمبریں اپڈیٹ کر دیے گئے', 'success');
                }
            }
        }

        function promoteStudents() {
            if (confirm('کیا آپ تمام طلبہ کو اگلی کلاس میں بھیجنا چاہتے ہیں؟')) {
                const newClass = prompt('نئی کلاس کا نام:');
                if (newClass) {
                    createNewRegister();
                    showNotification('طلبہ کی ترقی مکمل', 'success');
                }
            }
        }

        function bulkDelete() {
            if (confirm('کیا آپ تمام منتخب شدہ ڈیٹا ڈیلیٹ کرنا چاہتے ہیں؟')) {
                const option = prompt('کیا ڈیلیٹ کریں:\n1 = حاضری\n2 = نمبریں\n3 = دونوں');
                
                switch(option) {
                    case '1':
                        attendance3 = {};
                        renderAttendanceTable();
                        break;
                    case '2':
                        marks4 = {};
                        renderMarksTable();
                        break;
                    case '3':
                        attendance3 = {};
                        marks4 = {};
                        renderAttendanceTable();
                        renderMarksTable();
                        break;
                }
                
                autoSave();
                showNotification('ڈیٹا ڈیلیٹ کر دیا گیا', 'info');
            }
        }

        function generateReport() {
            const reportType = document.getElementById('reportType').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const studentFilter = document.getElementById('studentFilter').value;
            
            let html = `
                <div style="background: white; padding: 20px; margin-top: 20px; border-radius: 10px; border: 1px solid #ddd;">
                    <h2 style="text-align: center; color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px;">
                        ${adminData5.schoolName || 'اسکول'} - ${reportType} رپورٹ
                    </h2>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin: 20px 0;">
                        <div><strong>استاد:</strong> ${adminData5.teacherName || 'نامعلوم'}</div>
                        <div><strong>کلاس:</strong> ${adminData5.className || 'نامعلوم'}</div>
                        <div><strong>سیکشن:</strong> ${adminData5.sectionName || 'نامعلوم'}</div>
                        <div><strong>تاریخ:</strong> ${new Date().toLocaleDateString('ur-PK')}</div>
                    </div>
            `;
            
            if (reportType === 'attendance' || reportType === 'detailed') {
                html += `
                    <h3 style="color: #3498db; border-bottom: 1px solid #bdc3c7; padding-bottom: 5px;">حاضری کی تفصیلات</h3>
                    <table style="width: 100%; border-collapse: collapse; margin: 10px 0;">
                        <tr style="background: #ecf0f1;">
                            <th style="border: 1px solid #bdc3c7; padding: 8px;">طالب علم</th>
                            <th style="border: 1px solid #bdc3c7; padding: 8px;">کل حاضری</th>
                            <th style="border: 1px solid #bdc3c7; padding: 8px;">فیصد</th>
                            <th style="border: 1px solid #bdc3c7; padding: 8px;">درجہ</th>
                        </tr>
                `;
                
                const studentsToShow = studentFilter ? [students2[studentFilter]] : students2;
                
                studentsToShow.forEach((student, studentIndex) => {
                    const actualIndex = studentFilter ? studentFilter : studentIndex;
                    let presentDays = 0;
                    const totalDays = document.getElementById('dateRow').children.length - 3;
                    
                    for (let day = 1; day <= totalDays; day++) {
                        if (attendance3[`${actualIndex}_${day}`] === 'present') {
                            presentDays++;
                        }
                    }
                    
                    const percentage = totalDays > 0 ? Math.round((presentDays / totalDays) * 100) : 0;
                    let grade = 'ممتاز';
                    if (percentage < 90) grade = 'بہت اچھا';
                    if (percentage < 80) grade = 'اچھا';
                    if (percentage < 70) grade = 'متوسط';
                    if (percentage < 60) grade = 'کمزور';
                    
                    html += `
                        <tr>
                            <td style="border: 1px solid #bdc3c7; padding: 8px;">${student.name}</td>
                            <td style="border: 1px solid #bdc3c7; padding: 8px; text-align: center;">${presentDays}/${totalDays}</td>
                            <td style="border: 1px solid #bdc3c7; padding: 8px; text-align: center;">${percentage}%</td>
                            <td style="border: 1px solid #bdc3c7; padding: 8px; text-align: center;">${grade}</td>
                        </tr>
                    `;
                });
                
                html += '</table>';
            }
            
            if (reportType === 'marks' || reportType === 'detailed') {
                html += `
                    <h3 style="color: #3498db; border-bottom: 1px solid #bdc3c7; padding-bottom: 5px; margin-top: 20px;">نمبریں کی تفصیلات</h3>
                    <table style="width: 100%; border-collapse: collapse; margin: 10px 0;">
                        <tr style="background: #ecf0f1;">
                            <th style="border: 1px solid #bdc3c7; padding: 8px;">طالب علم</th>
                            ${subjects10.map(subject => `<th style="border: 1px solid #bdc3c7; padding: 8px;">${subject}</th>`).join('')}
                            <th style="border: 1px solid #bdc3c7; padding: 8px;">کل</th>
                            <th style="border: 1px solid #bdc3c7; padding: 8px;">فیصد</th>
                            <th style="border: 1px solid #bdc3c7; padding: 8px;">گریڈ</th>
                            <th style="border: 1px solid #bdc3c7; padding: 8px;">نتیجہ</th>
                        </tr>
                `;
                
                const studentsToShow = studentFilter ? [students2[studentFilter]] : students2;
                
                studentsToShow.forEach((student, studentIndex) => {
                    const actualIndex = studentFilter ? studentFilter : studentIndex;
                    let total = 0;
                    let subjectMarks = '';
                    
                    subjects10.forEach(subject => {
                        const markKey = `${actualIndex}_${subject}`;
                        const mark = marks4[markKey] || 0;
                        total += mark;
                        subjectMarks += `<td style="border: 1px solid #bdc3c7; padding: 8px; text-align: center;">${mark}</td>`;
                    });
                    
                    const maxMarks = subjects10.length * totalMarks12;
                    const percentage = Math.round((total / maxMarks) * 100);
                    const grade = calculateGrade(percentage);
                    const result = percentage >= passMarks11 ? 'کامیاب' : 'ناکام';
                    
                    html += `
                        <tr>
                            <td style="border: 1px solid #bdc3c7; padding: 8px;">${student.name}</td>
                            ${subjectMarks}
                            <td style="border: 1px solid #bdc3c7; padding: 8px; text-align: center;">${total}</td>
                            <td style="border: 1px solid #bdc3c7; padding: 8px; text-align: center;">${percentage}%</td>
                            <td style="border: 1px solid #bdc3c7; padding: 8px; text-align: center;">${grade}</td>
                            <td style="border: 1px solid #bdc3c7; padding: 8px; text-align: center; color: ${result === 'کامیاب' ? 'green' : 'red'};">${result}</td>
                        </tr>
                    `;
                });
                
                html += '</table>';
            }
            
            html += '</div>';
            document.getElementById('reportContent').innerHTML = html;
            showNotification('رپورٹ تیار کر دی گئی', 'success');
        }

        function exportPDF() {
            generateReport();
            const content = document.getElementById('reportContent').innerHTML;
            const newWindow = window.open();
            newWindow.document.write(`
                <html>
                    <head>
                        <title>طلبہ کی رپورٹ</title>
                        <meta charset="UTF-8">
                        <style>
                            body { font-family: Arial, sans-serif; direction: rtl; }
                            table { border-collapse: collapse; width: 100%; }
                            th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
                            th { background-color: #f2f2f2; }
                            @media print { body { margin: 0; } }
                        </style>
                    </head>
                    <body>${content}</body>
                </html>
            `);
            newWindow.document.close();
            newWindow.print();
        }

        function exportHTML() {
            generateReport();
            const content = document.getElementById('reportContent').innerHTML;
            const blob = new Blob([`
                <!DOCTYPE html>
                <html lang="ur" dir="rtl">
                <head>
                    <meta charset="UTF-8">
                    <title>طلبہ کی رپورٹ</title>
                    <style>
                        body { font-family: Arial, sans-serif; direction: rtl; margin: 20px; }
                        table { border-collapse: collapse; width: 100%; margin: 10px 0; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
                        th { background-color: #f2f2f2; }
                        h2, h3 { color: #2c3e50; }
                    </style>
                </head>
                <body>${content}</body>
                </html>
            `], {type: 'text/html'});
            
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `students-report-${new Date().toISOString().split('T')[0]}.html`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function exportExcel() {
            generateReport();
            const table = document.querySelector('#reportContent table');
            if (!table) {
                showNotification('پہلے رپورٹ بنائیں', 'error');
                return;
            }
            
            let csv = '';
            const rows = table.querySelectorAll('tr');
            rows.forEach(row => {
                const cells = row.querySelectorAll('th, td');
                const rowData = Array.from(cells).map(cell => `"${cell.textContent.replace(/"/g, '""')}"`);
                csv += rowData.join(',') + '\n';
            });
            
            const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `students-data-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function emailReport() {
            generateReport();
            const content = document.getElementById('reportContent').innerHTML;
            const subject = encodeURIComponent('طلبہ کی رپورٹ');
            const body = encodeURIComponent(`رپورٹ کی تفصیلات:\n\n${document.getElementById('reportContent').textContent}`);
            
            window.open(`mailto:?subject=${subject}&body=${body}`);
        }

        function printReport() {
            generateReport();
            const content = document.getElementById('reportContent').innerHTML;
            const newWindow = window.open();
            newWindow.document.write(`
                <html>
                    <head>
                        <title>طلبہ کی رپورٹ</title>
                        <meta charset="UTF-8">
                        <style>
                            body { font-family: Arial, sans-serif; direction: rtl; }
                            table { border-collapse: collapse; width: 100%; }
                            th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
                            th { background-color: #f2f2f2; }
                            @media print { body { margin: 0; } }
                        </style>
                    </head>
                    <body>${content}</body>
                </html>
            `);
            newWindow.document.close();
            newWindow.print();
        }

        function trendAnalysis() {
            showNotification('رجحان کا تجزیہ مکمل', 'info');
        }

        function performanceAnalysis() {
            showNotification('کارکردگی کا تجزیہ مکمل', 'info');
        }

        function createNewRegister() {
            const name = prompt('نیا رجسٹر کا نام:');
            if (name && name.trim()) {
                const transaction = db1.transaction(['registers'], 'readwrite');
                transaction.objectStore('registers').put({ id: name.trim(), name: name.trim() });
                loadRegisters();
                switchRegister(name.trim());
                showNotification('نیا رجسٹر بنا دیا گیا', 'success');
            }
        }

        function loadRegisters() {
            const transaction = db1.transaction(['registers'], 'readonly');
            transaction.objectStore('registers').getAll().onsuccess = function(event) {
                const registers = event.target.result;
                const select = document.getElementById('registerSelect');
                select.innerHTML = '<option value="default">ڈیفالٹ رجسٹر</option>';
                
                registers.forEach(register => {
                    const option = document.createElement('option');
                    option.value = register.name;
                    option.textContent = register.name;
                    select.appendChild(option);
                });
                
                select.value = currentRegister6;
            };
        }

        function switchRegister(registerName) {
            currentRegister6 = registerName || document.getElementById('registerSelect').value;
            students2 = [];
            attendance3 = {};
            marks4 = {};
            adminData5 = {};
            loadData();
            renderAttendanceTable();
            renderMarksTable();
            showNotification('رجسٹر تبدیل کر دیا گیا', 'info');
        }

        function deleteRegister() {
            if (currentRegister6 === 'default') {
                showNotification('ڈیفالٹ رجسٹر کو ڈیلیٹ نہیں کیا جا سکتا', 'error');
                return;
            }
            
            if (confirm('کیا آپ اس رجسٹر کو ڈیلیٹ کرنا چاہتے ہیں؟')) {
                const transaction = db1.transaction(['registers'], 'readwrite');
                transaction.objectStore('registers').delete(currentRegister6);
                loadRegisters();
                switchRegister('default');
                showNotification('رجسٹر ڈیلیٹ کر دیا گیا', 'info');
            }
        }

        function backupData() {
            const data = {
                students: students2,
                attendance: attendance3,
                marks: marks4,
                admin: adminData5,
                register: currentRegister6,
                subjects: subjects10,
                timestamp: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `backup-${currentRegister6}-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            showNotification('بیک اپ مکمل', 'success');
        }

        function restoreData() {
            document.getElementById('backupRestore').click();
        }

        function clearAll() {
            if (confirm('کیا آپ تمام حاضری صاف کرنا چاہتے ہیں؟')) {
                attendance3 = {};
                renderAttendanceTable();
                autoSave();
                showNotification('حاضری صاف کر دی گئی', 'info');
            }
        }

        function resetAll() {
            if (confirm('کیا آپ سب کچھ ڈیلیٹ کرنا چاہتے ہیں؟')) {
                const transaction = db1.transaction(['students', 'attendance', 'marks', 'admin'], 'readwrite');
                transaction.objectStore('students').clear();
                transaction.objectStore('attendance').clear();
                transaction.objectStore('marks').clear();
                transaction.objectStore('admin').clear();
                
                students2 = [];
                attendance3 = {};
                marks4 = {};
                adminData5 = {};
                history7 = [];
                historyIndex8 = -1;
                
                renderAttendanceTable();
                renderMarksTable();
                loadAdminData();
                showNotification('تمام ڈیٹا صاف کر دیا گیا', 'info');
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function saveMarks() {
            saveData();
        }

        function exportData() {
            const data = {
                students: students2,
                attendance: attendance3,
                marks: marks4,
                admin: adminData5,
                register: currentRegister6,
                subjects: subjects10
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `register-${currentRegister6}-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function importData() {
            document.getElementById('dataImport').click();
        }

        document.getElementById('dataImport').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (confirm('کیا آپ اس ڈیٹا کو امپورٹ کرنا چاہتے ہیں؟')) {
                            students2 = data.students || [];
                            attendance3 = data.attendance || {};
                            marks4 = data.marks || {};
                            adminData5 = data.admin || {};
                            subjects10 = data.subjects || subjects10;
                            renderAttendanceTable();
                            renderMarksTable();
                            loadAdminData();
                            saveData();
                            showNotification('ڈیٹا امپورٹ کر دیا گیا', 'success');
                        }
                    } catch (error) {
                        showNotification('فائل کرپٹ ہے', 'error');
                    }
                };
                reader.readAsText(file);
            }
        });

        document.getElementById('backupRestore').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (confirm('کیا آپ بیک اپ بحال کرنا چاہتے ہیں؟')) {
                            students2 = data.students || [];
                            attendance3 = data.attendance || {};
                            marks4 = data.marks || {};
                            adminData5 = data.admin || {};
                            subjects10 = data.subjects || subjects10;
                            renderAttendanceTable();
                            renderMarksTable();
                            loadAdminData();
                            saveData();
                            showNotification('بیک اپ بحال کر دیا گیا', 'success');
                        }
                    } catch (error) {
                        showNotification('بیک اپ فائل کرپٹ ہے', 'error');
                    }
                };
                reader.readAsText(file);
            }
        });

        document.getElementById('csvImport').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const csv = e.target.result;
                    const lines = csv.split('\n');
                    let addedCount = 0;
                    
                    lines.forEach(line => {
                        const parts = line.split(',').map(p => p.trim().replace(/"/g, ''));
                        if (parts.length >= 1 && parts[0]) {
                            const student = {
                                name: parts[0],
                                rollNumber: parts[1] || '',
                                fatherName: parts[2] || '',
                                mobileNumber: parts[3] || '',
                                address: parts[4] || '',
                                register: currentRegister6
                            };
                            students2.push(student);
                            addedCount++;
                        }
                    });
                    
                    if (addedCount > 0) {
                        renderAttendanceTable();
                        renderMarksTable();
                        updateStudentFilter();
                        autoSave();
                        showNotification(`${addedCount} طلبہ CSV سے شامل کر دیے گئے`, 'success');
                    }
                };
                reader.readAsText(file);
            }
        });

        document.getElementById('logoUpload').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('logoPreview');
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                    localStorage.setItem('schoolLogo', e.target.result);
                    showNotification('لوگو اپ لوڈ ہو گیا', 'success');
                };
                reader.readAsDataURL(file);
            }
        });

        document.getElementById('registerSelect').addEventListener('change', function() {
            switchRegister();
        });

        document.getElementById('markingType').addEventListener('change', function() {
            renderAttendanceTable();
        });

        document.getElementById('passMarks').addEventListener('change', function() {
            passMarks11 = parseInt(this.value);
            renderMarksTable();
            autoSave();
        });

        document.getElementById('totalMarks').addEventListener('change', function() {
            totalMarks12 = parseInt(this.value);
            renderMarksTable();
            autoSave();
        });

        ['schoolName', 'className', 'sectionName', 'teacherName', 'monthYear'].forEach(id => {
            document.getElementById(id).addEventListener('blur', function() {
                saveAdminData();
                autoSave();
            });
        });

        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey) {
                switch(e.key) {
                    case 'z':
                        e.preventDefault();
                        undo();
                        break;
                    case 'y':
                        e.preventDefault();
                        redo();
                        break;
                    case 's':
                        e.preventDefault();
                        saveData();
                        break;
                    case 'n':
                        e.preventDefault();
                        addStudent();
                        break;
                    case 'p':
                        e.preventDefault();
                        printReport();
                        break;
                }
            }
        });

        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        };

        window.onload = function() {
            initDB();
            document.getElementById('monthYear').value = new Date().toISOString().slice(0, 7);
            document.getElementById('startDate').value = new Date().toISOString().slice(0, 10);
            document.getElementById('endDate').value = new Date().toISOString().slice(0, 10);
            
            const savedLogo = localStorage.getItem('schoolLogo');
            if (savedLogo) {
                const preview = document.getElementById('logoPreview');
                preview.src = savedLogo;
                preview.style.display = 'block';
            }
            
            generateDays();
            showNotification('سسٹم تیار ہے', 'success');
        };
    </script>
</body>
</html>
